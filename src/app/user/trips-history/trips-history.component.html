<div class="container-fluid py-4" dir="rtl">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <h2 class="fw-bold mb-0">
          <i class="fas fa-history me-2 text-primary"></i>
          سجل الرحلات
        </h2>
        <div class="btn-group" role="group">
          <button 
            type="button" 
            class="btn btn-outline-primary"
            [class.active]="historyView === 'vehicle'"
            (click)="toggleHistoryView()">
            <i class="fas fa-car me-2"></i>
            رحلات المركبة
          </button>
          <button 
            type="button" 
            class="btn btn-outline-primary"
            [class.active]="historyView === 'driver'"
            (click)="toggleHistoryView()">
            <i class="fas fa-user me-2"></i>
            رحلاتي
          </button>
        </div>
      </div>
      <div class="alert alert-info mt-3 mb-0">
        <i class="fas fa-info-circle me-2"></i>
        {{ historyView === 'vehicle' ? 'عرض جميع الرحلات لهذه المركبة (جميع السائقين)' : 'عرض رحلاتي فقط (جميع المركبات)' }}
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4 g-3">
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="mb-1 opacity-75">إجمالي الرحلات</p>
              <h3 class="fw-bold mb-0">{{ totalTrips }}</h3>
            </div>
            <i class="fas fa-route fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="mb-1 opacity-75">الرحلات المكتملة</p>
              <h3 class="fw-bold mb-0">{{ completedTrips }}</h3>
            </div>
            <i class="fas fa-check-circle fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card border-0 shadow-sm bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p class="mb-1 opacity-75">إجمالي الأرباح</p>
              <h3 class="fw-bold mb-0">${{ totalEarnings.toFixed(2) }}</h3>
            </div>
            <i class="fas fa-dollar-sign fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <!-- Search -->
        <div class="col-12 col-md-4">
          <label class="form-label fw-bold">
            <i class="fas fa-search me-2"></i>
            بحث
          </label>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="searchTerm"
            (ngModelChange)="applyFilters(); calculateStatistics()"
            placeholder="ابحث عن مريض أو موقع...">
        </div>

        <!-- Month Filter -->
        <div class="col-6 col-md-2">
          <label class="form-label fw-bold">
            <i class="fas fa-calendar-alt me-2"></i>
            الشهر
          </label>
          <select 
            class="form-select" 
            [(ngModel)]="selectedMonth"
            (ngModelChange)="loadTrips()">
            <option *ngFor="let month of months" [value]="month.value">
              {{ month.name }}
            </option>
          </select>
        </div>

        <!-- Year Filter -->
        <div class="col-6 col-md-2">
          <label class="form-label fw-bold">
            <i class="fas fa-calendar me-2"></i>
            السنة
          </label>
          <select 
            class="form-select" 
            [(ngModel)]="selectedYear"
            (ngModelChange)="loadTrips()">
            <option *ngFor="let year of years" [value]="year">
              {{ year }}
            </option>
          </select>
        </div>

        <!-- Status Filter -->
        <div class="col-12 col-md-4">
          <label class="form-label fw-bold">
            <i class="fas fa-filter me-2"></i>
            حالة النقل
          </label>
          <select 
            class="form-select" 
            [(ngModel)]="selectedStatus"
            (ngModelChange)="applyFilters(); calculateStatistics()">
            <option value="All">جميع الحالات</option>
            <option *ngFor="let status of transferStatuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && getPaginatedTrips().length === 0" class="text-center py-5">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <p class="text-muted">لا توجد رحلات سابقة</p>
  </div>

  <!-- Trips Cards -->
  <div class="row row-cols-1 g-3" *ngIf="!isLoading && getPaginatedTrips().length > 0">
    <div class="col" *ngFor="let trip of getPaginatedTrips()">
      <div class="card shadow-sm rounded-xl border-0 overflow-hidden h-100" dir="rtl" style="cursor: pointer;" (click)="viewTripDetails(trip)">
        <div class="d-flex">
          <div class="flex-shrink-0" style="width: 6px;"
            [style.background-color]="getStatusColor(trip.transferStatus)"></div>

          <div class="card-body p-4 flex-grow-1 text-end">
            <!-- Patient Name and Amount -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold m-0 text-dark">
                <i class="fas fa-user-injured me-2 text-muted"></i>
                {{ trip.patientName }}
                <small class="text-muted">({{ trip.patientAge }} سنة)</small>
              </h6>
              <h6 class="fw-bold m-0 text-success" dir="ltr">₪{{ (trip.driverShare || 0).toFixed(2) }}</h6>
            </div>

            <!-- Date and Time -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <p class="text-muted small m-0">
                <i class="fas fa-calendar-day me-1"></i>
                {{ formatDate(trip.day, trip.month, trip.year) }}
              </p>
              <p class="text-muted small m-0">
                <i class="fas fa-clock me-1"></i>
                {{ formatTime(trip.start) }} - {{ formatTime(trip.end) }}
              </p>
            </div>

            <!-- Driver and Paramedic -->
            <div class="mb-3">
              <p class="text-muted small mb-1">
                <i class="fas fa-user me-1"></i>
                السائق: <span class="fw-medium text-dark">{{ trip.driver }}</span>
              </p>
              <p class="text-muted small m-0">
                <i class="fas fa-user-md me-1"></i>
                الضابط: <span class="fw-medium text-dark">{{ trip.paramedic }}</span>
              </p>
            </div>

            <!-- Diagnosis -->
            <p class="text-muted small mb-3">
              <i class="fas fa-notes-medical me-1"></i>
              <span class="fw-medium">التشخيص:</span> {{ trip.diagnosis }}
            </p>

            <!-- Transfer Route -->
            <div class="d-flex align-items-center gap-2 small fw-medium text-dark justify-content-end mb-3 pb-3 border-bottom">
              <span>
                <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                {{ trip.transferFrom }}
              </span>
              <i class="fas fa-arrow-left"></i>
              <span>
                <i class="fas fa-map-marker-alt me-1 text-success"></i>
                {{ trip.transferTo }}
              </span>
            </div>

            <!-- Status Badge -->
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">
                  <i class="fas fa-gas-pump me-1"></i>
                  سولار: {{ trip.diesel.toFixed(1) }} لتر
                </small>
              </div>
              <span class="badge rounded-pill {{ getStatusBadgeClass(trip.transferStatus) }}">
                {{ trip.transferStatus }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="col-12 text-center text-muted py-5" *ngIf="filteredTrips.length === 0">
      <i class="fas fa-inbox fa-3x mb-3"></i>
      <p class="h5 mb-0">لا توجد رحلات في هذه الفترة</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="mt-4" *ngIf="totalPages > 1">
    <nav aria-label="التنقل بين الصفحات">
      <ul class="pagination justify-content-center mb-0">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="previousPage()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </li>
        <li
          class="page-item"
          *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="currentPage === i + 1">
          <button class="page-link" (click)="goToPage(i + 1)">
            {{ i + 1 }}
          </button>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="nextPage()">
            <i class="fas fa-chevron-left"></i>
          </button>
        </li>
      </ul>
    </nav>
  </div>
</div>