<div class="container-fluid py-4" dir="rtl">
  <!-- Admin Alert - Show only for admins -->
  <div *ngIf="isAdmin()" class="alert alert-info d-flex justify-content-between align-items-center mb-4">
    <div>
      <i class="fas fa-user-shield me-2"></i>
      <strong>أنت مسجل كمسؤول</strong> - تعرض حالياً واجهة السائق
    </div>
    <button class="btn btn-sm btn-primary" (click)="returnToAdmin()">
      <i class="fas fa-arrow-left me-2"></i>
      العودة إلى لوحة الإدارة
    </button>
  </div>

  <!-- حالة السائق -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-success text-white border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <h2 class="display-4 fw-bold mb-2">{{ driverStatus() }}</h2>
          <p class="mb-0 opacity-75">مرحباً {{ driverName() }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- أزرار التحكم -->
  <div class="row mb-4 g-3">
    <div class="col-6">
      <button class="btn btn-primary w-100 py-3 fw-bold" (click)="startTrip()">
        بدء رحلة
      </button>
    </div>
    <div class="col-6">
      <button class="btn btn-outline-secondary w-100 py-3 fw-bold" (click)="endShift()">
        إنهاء الدوام
      </button>
    </div>
  </div>

  <!-- ملخص اليوم -->
  <h3 class="fw-bold mb-3">ملخص اليوم</h3>
  <div class="row mb-4 g-3">
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm">
        <div class="card-body">
          <p class="text-muted mb-2">الرحلات المكتملة</p>
          <h2 class="display-5 fw-bold mb-0">{{ tripsCompleted() }}</h2>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm">
        <div class="card-body">
          <p class="text-muted mb-2">أرباح اليوم</p>
          <h2 class="display-5 fw-bold mb-0">{{ totalEarnings() | number:'1.0-2' }} ₪</h2>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm" [class.border-warning]="pendingLoansCount() > 0">
        <div class="card-body">
          <p class="text-muted mb-2">ديون غير محصّلة</p>
          <h2 class="display-5 fw-bold mb-0" [class.text-warning]="pendingLoansCount() > 0">{{ pendingLoansCount() }}</h2>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm" [class.border-warning]="pendingLoansAmount() > 0">
        <div class="card-body">
          <p class="text-muted mb-2">إجمالي الديون</p>
          <h2 class="display-5 fw-bold mb-0" [class.text-warning]="pendingLoansAmount() > 0">{{ pendingLoansAmount() | number:'1.0-2' }} ₪</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- الموقع الحالي - Map -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border shadow-sm overflow-hidden">
        <div class="row g-0">
          <div class="col-12 col-lg-8">
            <div class="map-container">
              <div id="driver-location-map" class="driver-map"></div>
              @if (isLocationLoading()) {
                <div class="map-loading">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-2 mb-0">جاري تحديد الموقع...</p>
                </div>
              }
              @if (locationError()) {
                <div class="map-error">
                  <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                  <p class="mb-0">{{ locationError() }}</p>
                </div>
              }
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">الموقع الحالي</h5>
                <button class="btn btn-sm btn-light rounded-circle" (click)="refreshLocation()" [disabled]="isLocationLoading()">
                  <i class="fas fa-sync-alt" [class.fa-spin]="isLocationLoading()"></i>
                </button>
              </div>
              @if (currentPosition()) {
                <p class="text-muted mb-2">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  {{ getFormattedLocation() }}
                </p>
                <p class="text-muted small mb-0">
                  <i class="fas fa-clock me-1"></i>
                  آخر تحديث: {{ currentPosition()!.timestamp | date:'shortTime' }}
                </p>
              } @else if (!locationError()) {
                <p class="text-muted mb-0">جاري تحديد الموقع...</p>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- الإجراءات السريعة -->
  <h3 class="fw-bold mb-3">الإجراءات السريعة</h3>
  <div class="row g-3 mb-5">
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm h-100" role="button" (click)="openFuelModal()">
        <div class="card-body text-center d-flex flex-column align-items-center justify-content-center py-4">
          <i class="fas fa-gas-pump text-primary fa-2x mb-3"></i>
          <p class="fw-medium mb-0">إضافة وقود</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm h-100" role="button" (click)="openMaintenanceModal()">
        <div class="card-body text-center d-flex flex-column align-items-center justify-content-center py-4">
          <i class="fas fa-wrench text-primary fa-2x mb-3"></i>
          <p class="fw-medium mb-0">إضافة صيانة</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm h-100" role="button" (click)="viewTrips()">
        <div class="card-body text-center d-flex flex-column align-items-center justify-content-center py-4">
          <i class="fas fa-receipt text-primary fa-2x mb-3"></i>
          <p class="fw-medium mb-0">عرض الرحلات</p>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border shadow-sm h-100 position-relative" role="button" (click)="viewLoans()">
        <div class="card-body text-center d-flex flex-column align-items-center justify-content-center py-4">
          <i class="fas fa-hand-holding-usd text-success fa-2x mb-3"></i>
          <p class="fw-medium mb-0">تحصيل الديون</p>
          @if (pendingLoansCount() > 0) {
            <span class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-danger">
              {{ pendingLoansCount() }}
            </span>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fuel Modal -->
<app-add-fuel-modal 
  *ngIf="showFuelModal" 
  (close)="closeFuelModal()"
  (fuelAdded)="onFuelAdded()">
</app-add-fuel-modal>

<!-- Maintenance Modal -->
<app-add-maintenance-modal 
  *ngIf="showMaintenanceModal" 
  (close)="closeMaintenanceModal()"
  (maintenanceAdded)="onMaintenanceAdded()">
</app-add-maintenance-modal>
