<div *ngIf="isLoading" class="loading-container">
  <div class="spinner-grow text-primary" role="status">
    <span class="visually-hidden">جاري التحميل...</span>
  </div>
  <p class="mt-3 text-muted fw-medium">جاري تحميل النموذج الطبي...</p>
</div>

<div *ngIf="!isLoading" class="medical-form-container fade-in">
  
  <div class="card card-modern header-card mb-4">
    <div class="card-body p-4">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
        <div>
          <h1 class="form-title mb-1">
            <span class="icon-circle me-2"><i class="fas fa-notes-medical"></i></span>
            النموذج الطبي
          </h1>
          <p class="text-muted mb-0 trip-id-text">
            <i class="fas fa-hashtag me-1"></i> رحلة {{ tripId }}
          </p>
        </div>
        <button class="btn btn-light-secondary btn-go-back" (click)="goBack()">
          <i class="fas fa-arrow-right me-2"></i>
          رجوع
        </button>
      </div>

      <div class="status-section rounded-3 p-3 border border-dashed">
        <div class="row g-3 align-items-center">

          <!-- Completion Percentage 
          <div class="col-12 col-lg-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-bold text-dark fs-sm">نسبة الاكتمال</span>
              <span class="badge rounded-pill percentage-badge shadow-sm" [style.background-color]="getCompletionColor()">
                {{ completionPercentage }}%
              </span>
            </div>
            <div class="progress custom-progress">
              <div class="progress-bar" role="progressbar" [style.width.%]="completionPercentage"
              [style.background-color]="getCompletionColor()">
            </div>
          </div>
        </div>
        -->

          <div class="col-12 col-lg-7">
            <div class="d-flex flex-column flex-md-row justify-content-lg-end align-items-center gap-3">
              
              <div class="status-badges d-flex flex-wrap gap-2 justify-content-center">
                <span class="badge rounded-pill bg-info-subtle text-info" *ngIf="isSaving">
                  <i class="fas fa-spinner fa-spin me-1"></i> جاري الحفظ
                </span>
                <span class="badge rounded-pill bg-success-subtle text-success" *ngIf="!isSaving && canEdit">
                  <i class="fas fa-check me-1"></i> تم الحفظ
                </span>
                <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis" *ngIf="isLocked && !isComplete">
                  <i class="fas fa-lock me-1"></i> مقفل
                </span>
                <span class="badge rounded-pill bg-primary-subtle text-primary" *ngIf="isComplete">
                  <i class="fas fa-check-circle me-1"></i> مكتمل
                </span>
                <span class="badge rounded-pill bg-dark-subtle text-dark" *ngIf="isAdmin">
                  <i class="fas fa-user-shield me-1"></i> مدير
                </span>
                <span class="badge rounded-pill bg-danger-subtle text-danger" *ngIf="!canEdit && !isAdmin">
                  <i class="fas fa-ban me-1"></i> للقراءة فقط
                </span>
              </div>

              <div class="action-buttons d-flex gap-2">
                <button class="btn btn-primary btn-action" *ngIf="canEdit && !isLocked && !isComplete"
                  (click)="openCompleteConfirmModal()">
                  <i class="fas fa-check-circle me-2"></i>
                  <span>إكمال وقفل</span>
                </button>
                <button class="btn btn-warning btn-action text-white" *ngIf="isAdmin && isLocked" (click)="unlockForm()">
                  <i class="fas fa-unlock me-2"></i>
                  <span>فتح النموذج</span>
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="accordion custom-accordion" id="medicalFormAccordion">
    <div class="accordion-item card-modern mb-3" *ngFor="let section of sectionConfigs">
      <h2 class="accordion-header">
        <button class="accordion-button"
                [class.collapsed]="!expandedSections[section.key]"
                type="button"
                (click)="toggleSection(section.key)">
          <div class="d-flex align-items-center">
            <span class="section-icon-wrapper me-3">
              <i class="fas {{section.icon}}"></i>
            </span>
            <span class="fw-bold">{{ section.title }}</span>
          </div>
        </button>
      </h2>

      <div class="accordion-collapse collapse" [class.show]="expandedSections[section.key]">
        <div class="accordion-body">
          <div class="row g-4">
            <ng-container *ngFor="let field of section.fields">

              <div *ngIf="field.type !== 'subsection'" [ngClass]="field.colClass || 'col-12'">

                <ng-container *ngIf="field.type === 'text'">
                  <div class="form-group-modern">
                    <label class="form-label">{{ field.label }}</label>
                    <input type="text"
                           class="form-control"
                           [(ngModel)]="$any(formData)[section.key][field.key]"
                           (ngModelChange)="onFieldChange()"
                           [placeholder]="field.placeholder || ''"
                           [disabled]="!canEdit">
                  </div>
                </ng-container>

                <ng-container *ngIf="field.type === 'textarea'">
                  <div class="form-group-modern">
                    <label class="form-label">{{ field.label }}</label>
                    <textarea class="form-control"
                              [rows]="field.rows || 3"
                              [(ngModel)]="$any(formData)[section.key][field.key]"
                              (ngModelChange)="onFieldChange()"
                              [placeholder]="field.placeholder || ''"
                              [disabled]="!canEdit"></textarea>
                  </div>
                </ng-container>

                <ng-container *ngIf="field.type === 'checkbox'">
                  <div class="form-check custom-checkbox mt-2">
                    <input class="form-check-input"
                           type="checkbox"
                           [(ngModel)]="$any(formData)[section.key][field.key]"
                           (ngModelChange)="onFieldChange()"
                           [disabled]="!canEdit"
                           [id]="section.key + '_' + field.key">
                    <label class="form-check-label" [for]="section.key + '_' + field.key">
                      {{ field.label }}
                    </label>
                  </div>
                </ng-container>

                <ng-container *ngIf="field.type === 'checkboxGroup' && field.key === ''">
                  <label class="form-label fw-bold mb-2" *ngIf="field.label">{{ field.label }}</label>
                  <div class="checkbox-group-container">
                    <div class="form-check custom-checkbox" *ngFor="let checkboxField of field.fields">
                      <input class="form-check-input"
                             type="checkbox"
                             [(ngModel)]="$any(formData)[section.key][checkboxField.key]"
                             (ngModelChange)="onFieldChange()"
                             [disabled]="!canEdit"
                             [id]="section.key + '_' + checkboxField.key">
                      <label class="form-check-label" [for]="section.key + '_' + checkboxField.key">
                        {{ checkboxField.label }}
                      </label>
                    </div>
                  </div>
                </ng-container>

                <ng-container *ngIf="field.type === 'table'">
                  <label class="form-label fw-bold mb-3">{{ field.label }}</label>
                  <div class="table-responsive rounded-3 border">
                    <table class="table table-hover align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th class="border-0  "></th>
                          <th class="border-0   text-secondary" *ngFor="let col of field.tableConfig!.columns">{{ col }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let row of field.tableConfig!.rows">
                          <td class="fw-medium text-dark">{{ row.label }}</td>
                          <td *ngFor="let col of field.tableConfig!.columns; let i = index">
                            <input type="text"
                                   class="form-control form-control-sm border-0 bg-light-focus"
                                   [(ngModel)]="$any(formData)[section.key][field.key][row.key][i]"
                                   (ngModelChange)="onFieldChange()"
                                   [disabled]="!canEdit">
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </ng-container>
              </div>

              <div *ngIf="field.type === 'subsection'" [ngClass]="field.colClass || 'col-12'">
                <div class="subsection-card p-3 rounded-3  ">
                  <h6 class="subsection-title mb-3">
                    <i class="fas fa-chevron-left me-2 text-primary small-icon"></i>{{ field.label }}
                  </h6>
                  <div class="row g-3">
                    <ng-container *ngFor="let subfield of field.fields">
                      <div [ngClass]="subfield.colClass || 'col-12'">
                        
                        <ng-container *ngIf="subfield.type === 'text'">
                          <div class="form-group-modern">
                            <label class="form-label">{{ subfield.label }}</label>
                            <input type="text" class="form-control"
                                   [(ngModel)]="$any(formData)[section.key][field.key][subfield.key]"
                                   (ngModelChange)="onFieldChange()" [disabled]="!canEdit">
                          </div>
                        </ng-container>
                        
                        <ng-container *ngIf="subfield.type === 'textarea'">
                          <div class="form-group-modern">
                            <label class="form-label">{{ subfield.label }}</label>
                            <textarea class="form-control" [rows]="subfield.rows || 3"
                                      [(ngModel)]="$any(formData)[section.key][field.key][subfield.key]"
                                      (ngModelChange)="onFieldChange()" [disabled]="!canEdit"></textarea>
                          </div>
                        </ng-container>

                        <ng-container *ngIf="subfield.type === 'checkbox'">
                          <div class="form-check custom-checkbox mt-4">
                            <input class="form-check-input" type="checkbox"
                                   [(ngModel)]="$any(formData)[section.key][field.key][subfield.key]"
                                   (ngModelChange)="onFieldChange()" [disabled]="!canEdit"
                                   [id]="section.key + '_' + field.key + '_' + subfield.key">
                            <label class="form-check-label" [for]="section.key + '_' + field.key + '_' + subfield.key">
                              {{ subfield.label }}
                            </label>
                          </div>
                        </ng-container>

                        <ng-container *ngIf="subfield.type === 'checkboxGroup'">
                           <div class="checkbox-group-container">
                            <div class="form-check custom-checkbox" *ngFor="let checkboxField of subfield.fields">
                              <input class="form-check-input" type="checkbox"
                                     [(ngModel)]="$any(formData)[section.key][field.key][checkboxField.key]"
                                     (ngModelChange)="onFieldChange()" [disabled]="!canEdit"
                                     [id]="section.key + '_' + field.key + '_' + checkboxField.key">
                              <label class="form-check-label" [for]="section.key + '_' + field.key + '_' + checkboxField.key">
                                {{ checkboxField.label }}
                              </label>
                            </div>
                          </div>
                        </ng-container>

                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>

            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" [class.show]="showCompleteConfirmModal"
  [style.display]="showCompleteConfirmModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-backdrop-blur"></div>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white border-0">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-clipboard-check me-2"></i> تأكيد الإكمال
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeCompleteConfirmModal()"></button>
      </div>
      <div class="modal-body p-4 text-center">
        <div class="mb-3 text-success">
          <i class="fas fa-check-circle fa-4x"></i>
        </div>
        <h5 class="mb-3">هل أنت متأكد من إكمال النموذج؟</h5>
        <p class="text-muted mb-4">
          سيؤدي هذا الإجراء إلى قفل النموذج ومنع أي تعديلات مستقبلية إلا من قبل المدير.
        </p>
        <!-- show completion percentage
        <div class="d-inline-flex align-items-center bg-light rounded-pill px-3 py-1 mb-2">
          <span class="text-muted small me-2">نسبة الإنجاز:</span>
          <span class="fw-bold" [style.color]="getCompletionColor()">{{ completionPercentage }}%</span>
        </div>
        -->
      </div>
      <div class="modal-footer bg-light border-0 justify-content-center pb-4">
        <button type="button" class="btn btn-lg btn-light px-4" (click)="closeCompleteConfirmModal()">
          إلغاء
        </button>
        <button type="button" class="btn btn-lg btn-success px-4" (click)="confirmComplete()" [disabled]="isCompleting">
          <span *ngIf="!isCompleting">تأكيد الإكمال</span>
          <span *ngIf="isCompleting"><i class="fas fa-spinner fa-spin me-2"></i> جاري...</span>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showCompleteConfirmModal"></div>