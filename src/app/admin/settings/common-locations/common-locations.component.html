<div class="container-fluid p-4">
  <app-confirmation-modal
    [isOpen]="isDeleteModalOpen()"
    [config]="deleteConfig()"
    (confirmed)="confirmDelete()"
    (cancelled)="isDeleteModalOpen.set(false)">
</app-confirmation-modal>
  <!-- Header Actions -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <button class="btn btn-outline-secondary" (click)="goBack()">
      <i class="fa-solid fa-arrow-right me-2"></i>
      رجوع
    </button>
    <button class="btn btn-primary" (click)="openAddModal()">
      <i class="fa-solid fa-plus me-2"></i>
      إضافة موقع جديد
    </button>
  </div>

  <!-- Search and Filter -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="input-group">
        <span class="input-group-text bg-white">
          <i class="fa-solid fa-search text-muted"></i>
        </span>
        <input
          type="text"
          class="form-control"
          placeholder="بحث عن موقع..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="searchTerm.set($event); onFilterChange()"
        />
      </div>
    </div>
    <div class="col-md-4">
      <select class="form-select" [(ngModel)]="filterType" (ngModelChange)="filterType.set($event); onFilterChange()">
        <option *ngFor="let type of filterTypes" [value]="type">{{ type }}</option>
      </select>
    </div>
  </div>

  <!-- Card Grid -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
    @for (location of commonLocations(); track location.id) {
      <div class="col">
        <div class="card shadow-sm rounded-xl h-100 position-relative"
          [ngClass]="{'opacity-75': !location.isActive}">

          <!-- Action Buttons (top-left corner like drivers) -->
          <div class="position-absolute top-0 start-0 m-3 d-flex gap-2">
            <button
              class="btn btn-sm btn-outline-primary rounded-circle"
              style="width: 32px; height: 32px; padding: 0;"
              (click)="openEditModal(location)"
              title="تعديل">
              <i class="fa-solid fa-pen"></i>
            </button>
            <button
              class="btn btn-sm rounded-circle"
              [class.btn-outline-success]="!location.isActive"
              [class.btn-outline-warning]="location.isActive"
              style="width: 32px; height: 32px; padding: 0;"
              (click)="toggleStatus(location)"
              [title]="location.isActive ? 'تعطيل' : 'تفعيل'">
              <i class="fa-solid" [class.fa-check]="!location.isActive" [class.fa-ban]="location.isActive"></i>
            </button>
            <button
              class="btn btn-sm btn-outline-danger rounded-circle"
              style="width: 32px; height: 32px; padding: 0;"
              (click)="deleteLocation(location)"
              title="حذف">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>

          <!-- Card Content -->
          <div class="card-body pt-5">
            <h5 class="card-title fw-bold mb-2">{{ location.name }}</h5>
            <p class="text-muted small mb-2">
              <i class="fa-solid fa-tag me-1"></i>
              <span class="badge bg-info text-dark">{{ getTypeLabel(location.type) }}</span>
            </p>
            <p class="text-muted small mb-2" *ngIf="location.address">
              <i class="fa-solid fa-location-dot me-1"></i>
              {{ location.address }}
            </p>
            <p class="text-muted small mb-2" *ngIf="location.city">
              <i class="fa-solid fa-city me-1"></i>
              {{ location.city }}
            </p>
            <p class="text-muted small mb-2" *ngIf="location.phoneNumber" dir="ltr" class="text-end">
              <i class="fa-solid fa-phone me-1"></i>
              {{ location.phoneNumber }}
            </p>
            <p class="small mb-0">
              <span class="badge" [class.bg-success]="location.isActive" [class.bg-secondary]="!location.isActive">
                {{ location.isActive ? 'نشط' : 'غير نشط' }}
              </span>
            </p>
          </div>
        </div>
      </div>
    } @empty {
      <div class="col-12">
        <div class="text-center text-muted py-5">
          <i class="fa-solid fa-inbox fa-3x mb-3 d-block"></i>
          <p class="fs-5">لا توجد مواقع</p>
        </div>
      </div>
    }
  </div>

  <!-- Pagination -->
  <app-pagination
    [currentPage]="currentPage"
    [itemsPerPage]="itemsPerPage"
    [totalItems]="totalRecords"
    (pageChange)="onPageChange($event)"
    (itemsPerPageChange)="onItemsPerPageChange($event)">
  </app-pagination>
</div>

<!-- Add Modal -->
<div class="modal fade" [class.show]="isAddModalOpen()" [style.display]="isAddModalOpen() ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">إضافة موقع جديد</h5>
        <button type="button" class="btn-close" (click)="closeAddModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <!-- Select from Custom Locations -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">اختر من المواقع المخصصة (اختياري)</label>
              <select class="form-select" [(ngModel)]="selectedCustomLocationId" (ngModelChange)="onCustomLocationSelected($event)" name="customLocation">
                <option value="">-- اكتب يدوياً أو اختر موقع مخصص --</option>
                <option *ngFor="let loc of customLocations()" [value]="loc.id">{{ loc.name }}</option>
              </select>
              <small class="text-muted">إذا اخترت موقع مخصص، سيتم تحويله إلى موقع شائع</small>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">اسم الموقع <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="locationForm.name"
                name="name"
                placeholder="مثال: مستشفى الملك فيصل"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">نوع الموقع </label>
              <select class="form-select" [(ngModel)]="locationForm.type" name="type">
                <option *ngFor="let type of locationTypes" [value]="type.value">{{ type.label }}</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">العنوان </label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="locationForm.address"
                name="address"
                placeholder="مثال: شارع فيصل"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">المدينة </label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="locationForm.city"
                name="city"
                placeholder="مثال: نابلس"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">رقم الهاتف </label>
              <input
                type="tel"
                class="form-control"
                [(ngModel)]="locationForm.phoneNumber"
                name="phoneNumber"
                placeholder="0501234567"
                dir="ltr"
              />
            </div>
            <div class="col-md-6 mb-3 d-flex align-items-end">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [(ngModel)]="locationForm.isActive"
                  name="isActive"
                  id="addIsActive"
                />
                <label class="form-check-label" for="addIsActive">
                  نشط
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()">إلغاء</button>
        <button type="button" class="btn btn-primary" (click)="addLocation()">
          <i class="fa-solid fa-plus me-2"></i>
          إضافة
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="isAddModalOpen()" *ngIf="isAddModalOpen()"></div>

<!-- Edit Modal -->
<div class="modal fade" [class.show]="isEditModalOpen()" [style.display]="isEditModalOpen() ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تعديل الموقع</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">اسم الموقع <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="locationForm.name"
                name="name"
                placeholder="مثال: مستشفى الملك فيصل"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">نوع الموقع </label>
              <select class="form-select" [(ngModel)]="locationForm.type" name="type">
                <option *ngFor="let type of locationTypes" [value]="type.value">{{ type.label }}</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">العنوان </label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="locationForm.address"
                name="address"
                placeholder="مثال: شارع فيصل"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">المدينة </label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="locationForm.city"
                name="city"
                placeholder="مثال: نابلس"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">رقم الهاتف </label>
              <input
                type="tel"
                class="form-control"
                [(ngModel)]="locationForm.phoneNumber"
                name="phoneNumber"
                placeholder="0501234567"
                dir="ltr"
              />
            </div>
            <div class="col-md-6 mb-3 d-flex align-items-end">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [(ngModel)]="locationForm.isActive"
                  name="isActive"
                  id="editIsActive"
                />
                <label class="form-check-label" for="editIsActive">
                  نشط
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">إلغاء</button>
        <button type="button" class="btn btn-primary" (click)="updateLocation()">
          <i class="fa-solid fa-save me-2"></i>
          حفظ التغييرات
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="isEditModalOpen()" *ngIf="isEditModalOpen()"></div>
