<div class="d-flex flex-column min-vh-100 bg-light">

    <!-- Add Fuel Record Modal -->
    @if (isAddRecordModalOpen()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-xl shadow-lg border-0">
                <div class="modal-header bg-primary-custom rounded-top-xl border-0 justify-content-between text-white">
                    <h5 class="modal-title fw-bold text-dark">إضافة سجل وقود جديد</h5>
                    <button type="button" style="background-color: transparent; border: none;" data-bs-dismiss="modal" aria-label="Close"
                        (click)="isAddRecordModalOpen.set(false)"><i class="fa fa-times"></i></button>
                </div>
                <div class="modal-body p-4 text-end" style="max-height: 70vh; overflow-y: auto;">
                    <form (ngSubmit)="addRecord()">
                        <div class="row g-3">
                            <!-- Date Fields -->
                            <div class="col-12">
                                <label class="form-label small fw-medium">التاريخ</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.day" name="day" required>
                                            @for (day of getDaysInMonth(recordForm.month, recordForm.year); track day) {
                                            <option [value]="day">{{ day }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.month" name="month" required>
                                            @for (month of getMonths(); track month) {
                                            <option [value]="month">{{ month }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.year" name="year" required>
                                            @for (year of getYears(); track year) {
                                            <option [value]="year">{{ year }}</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label for="ambulanceName" class="form-label small fw-medium">اسم الإسعاف</label>
                                <select id="ambulanceName" class="form-select" [(ngModel)]="recordForm.ambulanceName" name="ambulanceName" required>
                                    <option value="">اختر الإسعاف</option>
                                    @for (ambulance of ambulanceList; track ambulance) {
                                        @if (ambulance !== 'جميع المركبات') {
                                        <option [value]="ambulance">{{ ambulance }}</option>
                                        }
                                    }
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="ambulanceNumber" class="form-label small fw-medium">رقم الإسعاف</label>
                                <input id="ambulanceNumber" type="text" class="form-control" placeholder="AMB-XXX"
                                    [(ngModel)]="recordForm.ambulanceNumber" name="ambulanceNumber" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="driverId" class="form-label small fw-medium">معرف السائق</label>
                                <input id="driverId" type="text" class="form-control" placeholder="D-XXX"
                                    [(ngModel)]="recordForm.driverId" name="driverId" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="driverName" class="form-label small fw-medium">اسم السائق</label>
                                <input id="driverName" type="text" class="form-control" placeholder="اسم السائق"
                                    [(ngModel)]="recordForm.driverName" name="driverName" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="odometerBefore" class="form-label small fw-medium">عداد المسافات (قبل)</label>
                                <input id="odometerBefore" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerBefore" name="odometerBefore" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="odometerAfter" class="form-label small fw-medium">عداد المسافات (بعد)</label>
                                <input id="odometerAfter" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerAfter" name="odometerAfter" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="fuelAmount" class="form-label small fw-medium">كمية الوقود (لتر)</label>
                                <input id="fuelAmount" type="number" class="form-control text-end" placeholder="0.0"
                                    [(ngModel)]="recordForm.fuelAmount" name="fuelAmount" min="0" step="0.1" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="cost" class="form-label small fw-medium">التكلفة (₪)</label>
                                <input id="cost" type="number" class="form-control text-end" placeholder="0.00"
                                    [(ngModel)]="recordForm.cost" name="cost" min="0" step="0.01" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="notes" class="form-label small fw-medium">ملاحظات</label>
                                <textarea id="notes" class="form-control" rows="3" placeholder="ملاحظات إضافية..."
                                    [(ngModel)]="recordForm.notes" name="notes"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold"
                                (click)="isAddRecordModalOpen.set(false)">إلغاء</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">إضافة</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Edit Fuel Record Modal -->
    @if (isEditRecordModalOpen() && selectedRecord()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-xl shadow-lg border-0">
                <div class="modal-header bg-warning rounded-top-xl border-0 justify-content-between text-dark">
                    <h5 class="modal-title fw-bold">تعديل سجل الوقود</h5>
                    <button type="button" style="background-color: transparent; border: none;" data-bs-dismiss="modal" aria-label="Close"
                        (click)="closeEditRecordModal()"><i class="fa fa-times"></i></button>
                </div>
                <div class="modal-body p-4 text-end" style="max-height: 70vh; overflow-y: auto;">
                    <form (ngSubmit)="saveEditRecord()">
                        <div class="row g-3">
                            <!-- Date Fields -->
                            <div class="col-12">
                                <label class="form-label small fw-medium">التاريخ</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.day" name="day" required>
                                            @for (day of getDaysInMonth(recordForm.month, recordForm.year); track day) {
                                            <option [value]="day">{{ day }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.month" name="month" required>
                                            @for (month of getMonths(); track month) {
                                            <option [value]="month">{{ month }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.year" name="year" required>
                                            @for (year of getYears(); track year) {
                                            <option [value]="year">{{ year }}</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label for="editAmbulanceName" class="form-label small fw-medium">اسم الإسعاف</label>
                                <select id="editAmbulanceName" class="form-select" [(ngModel)]="recordForm.ambulanceName" name="ambulanceName" required>
                                    @for (ambulance of ambulanceList; track ambulance) {
                                        @if (ambulance !== 'جميع المركبات') {
                                        <option [value]="ambulance">{{ ambulance }}</option>
                                        }
                                    }
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="editAmbulanceNumber" class="form-label small fw-medium">رقم الإسعاف</label>
                                <input id="editAmbulanceNumber" type="text" class="form-control" placeholder="AMB-XXX"
                                    [(ngModel)]="recordForm.ambulanceNumber" name="ambulanceNumber" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editDriverId" class="form-label small fw-medium">معرف السائق</label>
                                <input id="editDriverId" type="text" class="form-control" placeholder="D-XXX"
                                    [(ngModel)]="recordForm.driverId" name="driverId" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editDriverName" class="form-label small fw-medium">اسم السائق</label>
                                <input id="editDriverName" type="text" class="form-control" placeholder="اسم السائق"
                                    [(ngModel)]="recordForm.driverName" name="driverName" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editOdometerBefore" class="form-label small fw-medium">عداد المسافات (قبل)</label>
                                <input id="editOdometerBefore" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerBefore" name="odometerBefore" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editOdometerAfter" class="form-label small fw-medium">عداد المسافات (بعد)</label>
                                <input id="editOdometerAfter" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerAfter" name="odometerAfter" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editFuelAmount" class="form-label small fw-medium">كمية الوقود (لتر)</label>
                                <input id="editFuelAmount" type="number" class="form-control text-end" placeholder="0.0"
                                    [(ngModel)]="recordForm.fuelAmount" name="fuelAmount" min="0" step="0.1" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editCost" class="form-label small fw-medium">التكلفة (₪)</label>
                                <input id="editCost" type="number" class="form-control text-end" placeholder="0.00"
                                    [(ngModel)]="recordForm.cost" name="cost" min="0" step="0.01" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="editNotes" class="form-label small fw-medium">ملاحظات</label>
                                <textarea id="editNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية..."
                                    [(ngModel)]="recordForm.notes" name="notes"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold"
                                (click)="closeEditRecordModal()">إلغاء</button>
                            <button type="submit" class="btn btn-warning rounded-pill px-4 fw-bold">حفظ التغييرات</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- View Fuel Record Details Modal -->
    @if (isViewRecordModalOpen() && selectedRecord()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-xl shadow-lg border-0">
                <div class="modal-header bg-primary-custom rounded-top-xl border-0 justify-content-between">
                    <h5 class="modal-title fw-bold">تفاصيل سجل الوقود</h5>
                    <button type="button" style="border: none; background: none;" data-bs-dismiss="modal" aria-label="Close"
                        (click)="closeViewRecordModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body p-4 text-end">
                    @if (selectedRecord(); as record) {
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <p class="text-muted small mb-1">الإسعاف</p>
                                    <h5 class="fw-bold">{{ record.ambulanceName }}</h5>
                                </div>
                                <span class="badge bg-success rounded-pill fw-bold">
                                    <i class="fa-solid fa-gas-pump me-1"></i>
                                    وقود
                                </span>
                            </div>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">التاريخ</p>
                            <p class="fw-bold">{{ formatDate(record.date) }}</p>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">رقم الإسعاف</p>
                            <p class="fw-bold">{{ record.ambulanceNumber }}</p>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">معرف السائق</p>
                            <p class="fw-bold">{{ record.driverId }}</p>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">اسم السائق</p>
                            <p class="fw-bold">{{ record.driverName }}</p>
                        </div>
                        <div class="col-12">
                            <p class="text-muted small mb-1">عداد المسافات</p>
                            <p class="fw-bold">
                                قبل: {{ record.odometerBefore.toLocaleString() }} ميل / 
                                بعد: {{ record.odometerAfter.toLocaleString() }} ميل
                            </p>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">كمية الوقود</p>
                            <p class="fw-bold">{{ record.fuelAmount.toFixed(1) }} لتر</p>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">التكلفة</p>
                            <p class="h4 fw-bold text-success" dir="ltr">₪{{ record.cost.toFixed(2) }}</p>
                        </div>
                        @if (record.notes) {
                        <div class="col-12">
                            <p class="text-muted small mb-1">ملاحظات</p>
                            <div class="alert alert-info d-flex align-items-start" role="alert">
                                <i class="fa-solid fa-sticky-note me-2 mt-1"></i>
                                <p class="mb-0">{{ record.notes }}</p>
                            </div>
                        </div>
                        }
                    </div>
                    <div class="d-flex justify-content-between gap-2 mt-4">
                        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold"
                            (click)="deleteRecord(record.id)">
                            <i class="fa-solid fa-trash me-1"></i>
                            حذف
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold"
                                (click)="closeViewRecordModal()">إغلاق</button>
                            <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold"
                                (click)="openEditRecordModal()">
                                <i class="fa-solid fa-edit me-1"></i>
                                تعديل
                            </button>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }
    
    <main class="flex-grow-1 p-3 p-lg-4" dir="rtl">
        <div class="container-fluid" style="max-width: 1200px;">
            
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="input-group shadow-sm">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fa-solid fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" 
                        placeholder="البحث في اسم الإسعاف، الرقم، السائق، أو الملاحظات..."
                        [(ngModel)]="searchTerm">
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card shadow-sm rounded-xl p-4 mb-4">
                <h5 class="fw-bold mb-3 text-end">تصفية السجلات</h5>
                
                <div class="row g-3 text-end">
                    <!-- Date Filter -->
                    <div class="col-md-6">
                        <label class="form-label small fw-medium">التاريخ</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="filterDay">
                                    @for (day of getDaysInMonth(filterMonth, filterYear); track day) {
                                    <option [value]="day">{{ day }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="filterMonth">
                                    @for (month of getMonths(); track month) {
                                    <option [value]="month">{{ month }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="filterYear">
                                    @for (year of getYears(); track year) {
                                    <option [value]="year">{{ year }}</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ambulance Filter -->
                    <div class="col-md-6">
                        <label for="ambulanceFilter" class="form-label small fw-medium">الإسعاف</label>
                        <select id="ambulanceFilter" class="form-select" [(ngModel)]="selectedAmbulance">
                            @for (ambulance of ambulanceList; track ambulance) {
                            <option [value]="ambulance">{{ ambulance }}</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-primary-custom fw-bold px-4" (click)="applyFilters()">
                        <i class="fa-solid fa-filter me-2"></i>
                        تطبيق الفلاتر
                    </button>
                    <button class="btn btn-outline-secondary px-4" (click)="clearFilters()">
                        <i class="fa-solid fa-times me-2"></i>
                        مسح
                    </button>
                </div>
            </div>

            <!-- Fuel Records List -->
            <div class="row row-cols-1 g-4">
                @for (record of filteredRecords(); track record.id) {
                <div class="col">
                    <div class="card shadow-sm rounded-xl overflow-hidden cursor-pointer-cu hover-lift"
                        (click)="viewRecordDetails(record)">
                        <div class="card-header bg-white border-bottom p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="text-end">
                                    <h5 class="fw-bold mb-1 cursor-pointer-cu text-primary" 
                                        (click)="$event.stopPropagation(); navigateToFleet('name', record.ambulanceName)">
                                        <i class="fa-solid fa-truck-medical me-2"></i>
                                        {{ record.ambulanceName }}
                                    </h5>
                                    <p class="text-muted small mb-0">{{ formatDate(record.date) }}</p>
                                </div>
                                <span class="badge bg-success rounded-pill fw-bold">
                                    <i class="fa-solid fa-gas-pump me-1"></i>
                                    {{ record.fuelAmount.toFixed(1) }} لتر
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 text-end">
                                <div class="col-6">
                                    <p class="text-muted small mb-1">رقم الإسعاف</p>
                                    <p class="fw-semibold mb-0 cursor-pointer-cu text-primary" 
                                        (click)="$event.stopPropagation(); navigateToFleet('number', record.ambulanceNumber)">
                                        <i class="fa-solid fa-hashtag"></i>
                                        {{ record.ambulanceNumber }}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">معرف السائق</p>
                                    <p class="fw-semibold mb-0 cursor-pointer-cu text-primary" 
                                        (click)="$event.stopPropagation(); navigateToFleet('driverId', record.driverId)">
                                        <i class="fa-solid fa-id-badge"></i>
                                        {{ record.driverId }}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">اسم السائق</p>
                                    <p class="fw-semibold mb-0 cursor-pointer-cu text-primary" 
                                        (click)="$event.stopPropagation(); navigateToDriver(record.driverName)">
                                        <i class="fa-solid fa-user"></i>
                                        {{ record.driverName }}
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">التكلفة</p>
                                    <p class="fw-semibold fs-5 mb-0 text-success" dir="ltr">
                                        ₪
                                        {{ record.cost.toFixed(2) }}
                                    </p>
                                </div>
                                <div class="col-12">
                                    <p class="text-muted small mb-1">عداد المسافات</p>
                                    <p class="fw-semibold mb-0">
                                        <i class="fa-solid fa-gauge-high text-danger me-1"></i>
                                        قبل: {{ record.odometerBefore.toLocaleString() }} ميل / 
                                        بعد: {{ record.odometerAfter.toLocaleString() }} ميل
                                    </p>
                                </div>
                                @if (record.notes) {
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-start mb-0" role="alert">
                                        <i class="fa-solid fa-sticky-note me-2 mt-1"></i>
                                        <p class="mb-0 small">{{ record.notes }}</p>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                } @empty {
                <div class="col-12 text-center text-muted p-5">
                    <i class="fa-solid fa-search fs-1 mb-3 opacity-50"></i>
                    <h5 class="fw-bold mb-2">لم يتم العثور على سجلات</h5>
                    <p>لا توجد سجلات تطابق معايير البحث المحددة.</p>
                </div>
                }
            </div>
        </div>
    </main>

    <!-- Floating Action Button -->
    <button class="fab shadow-lg" (click)="openAddRecordModal()">
        <i class="fa-solid fa-plus fa-lg"></i>
    </button>
</div>