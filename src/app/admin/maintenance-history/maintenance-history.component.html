<div class="d-flex flex-column min-vh-100 bg-light">

    <!-- Add Maintenance Record Modal -->
    @if (isAddRecordModalOpen()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-xl shadow-lg border-0">
                <div class="modal-header bg-primary-custom rounded-top-xl border-0 justify-content-between text-white">
                    <h5 class="modal-title fw-bold text-dark">إضافة سجل صيانة جديد</h5>
                    <button type="button" style="background-color: transparent; border: none;" data-bs-dismiss="modal" aria-label="Close"
                        (click)="isAddRecordModalOpen.set(false)"><i class="fa fa-times"></i></button>
                </div>
                <div class="modal-body p-4 text-end" style="max-height: 70vh; overflow-y: auto;">
                    <form (ngSubmit)="addRecord()">
                        <div class="row g-3">
                            <!-- Date Fields -->
                            <div class="col-12">
                                <label class="form-label small fw-medium">التاريخ</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.day" name="day" required>
                                            @for (day of getDaysInMonth(recordForm.month, recordForm.year); track day) {
                                            <option [value]="day">{{ day }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.month" name="month" required>
                                            @for (month of getMonths(); track month) {
                                            <option [value]="month">{{ month }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.year" name="year" required>
                                            @for (year of getYears(); track year) {
                                            <option [value]="year">{{ year }}</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label for="vehicleId" class="form-label small fw-medium">المركبة</label>
                                <select id="vehicleId" class="form-select" [(ngModel)]="recordForm.vehicleId" name="vehicleId" required>
                                    <option value="">اختر المركبة</option>
                                    @for (vehicle of vehiclesList; track vehicle) {
                                        @if (vehicle !== 'جميع المركبات') {
                                        <option [value]="vehicle">{{ vehicle }}</option>
                                        }
                                    }
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="type" class="form-label small fw-medium">نوع الصيانة</label>
                                <select id="type" class="form-select" [(ngModel)]="recordForm.type" name="type" required>
                                    <option value="">اختر النوع</option>
                                    @for (type of maintenanceTypes; track type) {
                                    <option [value]="type">{{ type }}</option>
                                    }
                                </select>
                            </div>
                            
                            <div class="col-6">
                                <label for="cost" class="form-label small fw-medium">التكلفة (₪)</label>
                                <input id="cost" type="number" class="form-control text-end" placeholder="0.00"
                                    [(ngModel)]="recordForm.cost" name="cost" min="0" step="0.01" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="status" class="form-label small fw-medium">الحالة</label>
                                <select id="status" class="form-select" [(ngModel)]="recordForm.status" name="status" required>
                                    @for (status of maintenanceStatuses; track status) {
                                    <option [value]="status">{{ status }}</option>
                                    }
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="serviceLocation" class="form-label small fw-medium">موقع الخدمة</label>
                                <input id="serviceLocation" type="text" class="form-control" placeholder="اسم مركز الصيانة"
                                    [(ngModel)]="recordForm.serviceLocation" name="serviceLocation" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="odometerBefore" class="form-label small fw-medium">عداد المسافات (قبل)</label>
                                <input id="odometerBefore" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerBefore" name="odometerBefore" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="odometerAfter" class="form-label small fw-medium">عداد المسافات (بعد)</label>
                                <input id="odometerAfter" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerAfter" name="odometerAfter" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="notes" class="form-label small fw-medium">ملاحظات</label>
                                <textarea id="notes" class="form-control" rows="3" placeholder="ملاحظات إضافية..."
                                    [(ngModel)]="recordForm.notes" name="notes"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold"
                                (click)="isAddRecordModalOpen.set(false)">إلغاء</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">إضافة</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Edit Maintenance Record Modal -->
    @if (isEditRecordModalOpen() && selectedRecord()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-xl shadow-lg border-0">
                <div class="modal-header bg-warning rounded-top-xl border-0 justify-content-between text-dark">
                    <h5 class="modal-title fw-bold">تعديل سجل الصيانة</h5>
                    <button type="button" style="background-color: transparent; border: none;" data-bs-dismiss="modal" aria-label="Close"
                        (click)="closeEditRecordModal()"><i class="fa fa-times"></i></button>
                </div>
                <div class="modal-body p-4 text-end" style="max-height: 70vh; overflow-y: auto;">
                    <form (ngSubmit)="saveEditRecord()">
                        <div class="row g-3">
                            <!-- Date Fields -->
                            <div class="col-12">
                                <label class="form-label small fw-medium">التاريخ</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.day" name="day" required>
                                            @for (day of getDaysInMonth(recordForm.month, recordForm.year); track day) {
                                            <option [value]="day">{{ day }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.month" name="month" required>
                                            @for (month of getMonths(); track month) {
                                            <option [value]="month">{{ month }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select" [(ngModel)]="recordForm.year" name="year" required>
                                            @for (year of getYears(); track year) {
                                            <option [value]="year">{{ year }}</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label for="editVehicleId" class="form-label small fw-medium">المركبة</label>
                                <select id="editVehicleId" class="form-select" [(ngModel)]="recordForm.vehicleId" name="vehicleId" required>
                                    @for (vehicle of vehiclesList; track vehicle) {
                                        @if (vehicle !== 'جميع المركبات') {
                                        <option [value]="vehicle">{{ vehicle }}</option>
                                        }
                                    }
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="editType" class="form-label small fw-medium">نوع الصيانة</label>
                                <select id="editType" class="form-select" [(ngModel)]="recordForm.type" name="type" required>
                                    @for (type of maintenanceTypes; track type) {
                                    <option [value]="type">{{ type }}</option>
                                    }
                                </select>
                            </div>
                            
                            <div class="col-6">
                                <label for="editCost" class="form-label small fw-medium">التكلفة (₪)</label>
                                <input id="editCost" type="number" class="form-control text-end" placeholder="0.00"
                                    [(ngModel)]="recordForm.cost" name="cost" min="0" step="0.01" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editStatus" class="form-label small fw-medium">الحالة</label>
                                <select id="editStatus" class="form-select" [(ngModel)]="recordForm.status" name="status" required>
                                    @for (status of maintenanceStatuses; track status) {
                                    <option [value]="status">{{ status }}</option>
                                    }
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="editServiceLocation" class="form-label small fw-medium">موقع الخدمة</label>
                                <input id="editServiceLocation" type="text" class="form-control" placeholder="اسم مركز الصيانة"
                                    [(ngModel)]="recordForm.serviceLocation" name="serviceLocation" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editOdometerBefore" class="form-label small fw-medium">عداد المسافات (قبل)</label>
                                <input id="editOdometerBefore" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerBefore" name="odometerBefore" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-6">
                                <label for="editOdometerAfter" class="form-label small fw-medium">عداد المسافات (بعد)</label>
                                <input id="editOdometerAfter" type="number" class="form-control text-end" placeholder="0"
                                    [(ngModel)]="recordForm.odometerAfter" name="odometerAfter" min="0" style="direction: ltr;" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="editNotes" class="form-label small fw-medium">ملاحظات</label>
                                <textarea id="editNotes" class="form-control" rows="3" placeholder="ملاحظات إضافية..."
                                    [(ngModel)]="recordForm.notes" name="notes"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold"
                                (click)="closeEditRecordModal()">إلغاء</button>
                            <button type="submit" class="btn btn-warning rounded-pill px-4 fw-bold">حفظ التغييرات</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- View Maintenance Record Details Modal -->
    @if (isViewRecordModalOpen() && selectedRecord()) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-xl shadow-lg border-0">
                <div class="modal-header bg-primary-custom rounded-top-xl border-0 justify-content-between">
                    <h5 class="modal-title fw-bold">تفاصيل سجل الصيانة</h5>
                    <button type="button" style="border: none; background: none;" data-bs-dismiss="modal" aria-label="Close"
                        (click)="closeViewRecordModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body p-4 text-end">
                    @if (selectedRecord(); as record) {
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <p class="text-muted small mb-1">المركبة</p>
                                    <h5 class="fw-bold">{{ record.vehicleId }}</h5>
                                </div>
                                <app-status-badge
                                    [status]="record.status"
                                    [type]="'maintenance'"
                                    size="medium">
                                </app-status-badge>
                            </div>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">التاريخ</p>
                            <p class="fw-bold">{{ formatDate(record.date) }}</p>
                        </div>
                        <div class="col-6">
                            <p class="text-muted small mb-1">نوع الصيانة</p>
                            <p class="fw-bold">{{ record.type }}</p>
                        </div>
                        <div class="col-12">
                            <p class="text-muted small mb-1">التكلفة</p>
                            <p class="h4 fw-bold text-primary" dir="ltr">₪{{ record.cost.toFixed(2) }}</p>
                        </div>
                        <div class="col-12">
                            <p class="text-muted small mb-1">موقع الخدمة</p>
                            <p class="fw-bold">{{ record.serviceLocation }}</p>
                        </div>
                        <div class="col-12">
                            <p class="text-muted small mb-1">عداد المسافات</p>
                            <p class="fw-bold">
                                قبل: {{ record.odometerBefore.toLocaleString() }} ميل / 
                                بعد: {{ record.odometerAfter.toLocaleString() }} ميل
                            </p>
                        </div>
                        <div class="col-12">
                            <p class="text-muted small mb-1">ملاحظات</p>
                            <p class="text-muted">{{ record.notes }}</p>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between gap-2 mt-4">
                        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold"
                            (click)="deleteRecord(record.id)">
                            <i class="fa-solid fa-trash me-1"></i>
                            حذف
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold"
                                (click)="closeViewRecordModal()">إغلاق</button>
                            <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold"
                                (click)="openEditRecordModal()">
                                <i class="fa-solid fa-edit me-1"></i>
                                تعديل
                            </button>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }
    
    <main class="flex-grow-1 p-3 p-lg-4" dir="rtl">
        <div class="container-fluid" style="max-width: 1200px;">
            
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="input-group shadow-sm">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fa-solid fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" 
                        placeholder="البحث في موقع الصيانة، المركبة، أو الملاحظات..."
                        [(ngModel)]="searchTerm">
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card shadow-sm rounded-xl p-4 mb-4">
                <h5 class="fw-bold mb-3 text-end">تصفية السجلات</h5>
                
                <div class="row g-3 text-end">
                    <!-- Start Date -->
                    <div class="col-md-6">
                        <label class="form-label small fw-medium">تاريخ البداية</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="startDay">
                                    @for (day of getDaysInMonth(startMonth, startYear); track day) {
                                    <option [value]="day">{{ day }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="startMonth">
                                    @for (month of getMonths(); track month) {
                                    <option [value]="month">{{ month }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="startYear">
                                    @for (year of getYears(); track year) {
                                    <option [value]="year">{{ year }}</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- End Date -->
                    <div class="col-md-6">
                        <label class="form-label small fw-medium">تاريخ النهاية</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="endDay">
                                    @for (day of getDaysInMonth(endMonth, endYear); track day) {
                                    <option [value]="day">{{ day }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="endMonth">
                                    @for (month of getMonths(); track month) {
                                    <option [value]="month">{{ month }}</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4">
                                <select class="form-select" [(ngModel)]="endYear">
                                    @for (year of getYears(); track year) {
                                    <option [value]="year">{{ year }}</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vehicle Filter -->
                    <div class="col-md-6">
                        <label for="vehicleFilter" class="form-label small fw-medium">المركبة</label>
                        <select id="vehicleFilter" class="form-select" [(ngModel)]="selectedVehicle">
                            @for (vehicle of vehiclesList; track vehicle) {
                            <option [value]="vehicle">{{ vehicle }}</option>
                            }
                        </select>
                    </div>
                    
                    <!-- Maintenance Type Filter -->
                    <div class="col-md-6">
                        <label for="maintenanceTypeFilter" class="form-label small fw-medium">نوع الصيانة</label>
                        <select id="maintenanceTypeFilter" class="form-select" [(ngModel)]="selectedMaintenanceType">
                            <option value="جميع الأنواع">جميع الأنواع</option>
                            @for (type of maintenanceTypes; track type) {
                            <option [value]="type">{{ type }}</option>
                            }
                        </select>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-primary-custom fw-bold px-4" (click)="applyFilters()">
                        <i class="fa-solid fa-filter me-2"></i>
                        تطبيق الفلاتر
                    </button>
                    <button class="btn btn-outline-secondary px-4" (click)="clearFilters()">
                        <i class="fa-solid fa-times me-2"></i>
                        مسح
                    </button>
                </div>
            </div>

            <!-- Maintenance Records List -->
            <div class="row row-cols-1 g-4">
                @for (record of getPaginatedMaintenanceRecords(); track record.id) {
                <div class="col">
                    <div class="card shadow-sm rounded-xl overflow-hidden cursor-pointer hover-lift"
                        (click)="viewRecordDetails(record)">
                        <div class="card-header bg-white border-bottom p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="text-end">
                                    <h5 class="fw-bold mb-1">{{ record.vehicleId }}</h5>
                                    <p class="text-muted small mb-0">{{ formatDate(record.date) }}</p>
                                </div>
                                <app-status-badge
                                    [status]="record.status"
                                    [type]="'maintenance'"
                                    size="medium">
                                </app-status-badge>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3 text-end">
                                <div class="col-6">
                                    <p class="text-muted small mb-1">نوع الصيانة</p>
                                    <p class="fw-semibold mb-0">{{ record.type }}</p>
                                </div>
                                <div class="col-6">
                                    <p class="text-muted small mb-1">التكلفة</p>
                                    <p class="fw-semibold fs-5 mb-0 text-primary" dir="ltr">₪{{ record.cost.toFixed(2) }}</p>
                                </div>
                                <div class="col-12">
                                    <p class="text-muted small mb-1">موقع الخدمة</p>
                                    <p class="fw-semibold mb-0">
                                        <i class="fa-solid fa-location-dot text-danger me-1"></i>
                                        {{ record.serviceLocation }}
                                    </p>
                                </div>
                                <div class="col-12">
                                    <p class="text-muted small mb-1">عداد المسافات</p>
                                    <p class="fw-semibold mb-0">
                                        قبل: {{ record.odometerBefore.toLocaleString() }} ميل /
                                        بعد: {{ record.odometerAfter.toLocaleString() }} ميل
                                    </p>
                                </div>
                                <div class="col-12">
                                    <p class="text-muted small mb-1">ملاحظات</p>
                                    <p class="text-muted mb-0">{{ record.notes }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                } @empty {
                <div class="col-12 text-center text-muted p-5">
                    <i class="fa-solid fa-search fs-1 mb-3 opacity-50"></i>
                    <h5 class="fw-bold mb-2">لم يتم العثور على سجلات</h5>
                    <p>لا توجد سجلات تطابق معايير البحث المحددة.</p>
                </div>
                }
            </div>

            <!-- Pagination -->
            @if (filteredRecords().length > 0) {
            <div class="mt-4">
                <app-pagination
                    [currentPage]="currentPage"
                    [totalItems]="filteredRecords().length"
                    [itemsPerPage]="itemsPerPage"
                    (pageChange)="onPageChange($event)"
                    (itemsPerPageChange)="onItemsPerPageChange($event)">
                </app-pagination>
            </div>
            }
        </div>
    </main>

    <!-- Floating Action Button -->
    <button class="fab shadow-lg" (click)="openAddRecordModal()">
        <i class="fa-solid fa-plus fa-lg"></i>
    </button>
</div>